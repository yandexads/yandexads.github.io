<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
	<title>3inarow</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
	
	<!-- Made with Construct, the game and app creator :: https://www.construct.net -->
	<meta name="generator" content="Scirra Construct">

	<link rel="manifest" href="appmanifest.json">
	<link rel="stylesheet" href="style.css">

	<!-- Tads.me and Telegram Web App scripts -->
	<script src="https://w.tads.me/widget.js"></script>
	<script src="https://telegram.org/js/telegram-web-app.js"></script>

	<style>
		#tads-container-308 {
			position: fixed;
			bottom: 0;
			left: 0;
			width: 100%;
			background-color: #000;
			z-index: 999999;
			display: none;
			opacity: 0;
			transition: opacity 0.3s ease-in-out;
			min-height: 50px;
			pointer-events: none; /* Отключаем взаимодействие пока реклама не готова */
		}
		#tads-container-308.ready {
			opacity: 1;
			pointer-events: auto; /* Включаем взаимодействие когда реклама готова */
		}
		#tads-container-308.loading {
			display: block;
			opacity: 0.5;
		}
		#tads-container-308.error {
			display: none;
		}
	</style>
</head> 
 
<body>
	<!-- Tads.me container -->
	<div id="tads-container-308"></div>

	<script>
		if (location.protocol.substr(0, 4) === "file")
		{
			alert("Web exports won't work until you upload them. (When running on the file: protocol, browsers block many features from working for security reasons.)");
		}
	</script>
	
	<noscript>
		<div id="notSupportedWrap">
			<h2 id="notSupportedTitle">This content requires JavaScript</h2>
			<p class="notSupportedMessage">JavaScript appears to be disabled. Please enable it to view this content.</p>
		</div>
	</noscript>

	<!-- Game scripts -->
	<script src="scripts/modernjscheck.js"></script>
	<script src="scripts/supportcheck.js"></script>
	<script src="scripts/offlineclient.js" type="module"></script>
	<script src="scripts/main.js" type="module"></script>
	<script src="scripts/register-sw.js" type="module"></script>

	<!-- Tads.me initialization -->
	<script>
		let adController = null;
		let isAdFullyLoaded = false;
		let isAdContainerReady = false;
		let retryCount = 0;
		const MAX_RETRIES = 3;
		const LOAD_TIMEOUT = 15000; // Увеличиваем таймаут до 15 секунд
		let loadTimeoutId = null;

		const adsNotFoundCallback = () => {
			console.log('No ads found to show');
			if (retryCount < MAX_RETRIES) {
				retryCount++;
				console.log(`Retrying ad load (attempt ${retryCount}/${MAX_RETRIES})...`);
				loadAd();
			} else {
				console.log('Max retries reached, giving up');
				handleAdError();
			}
		};

		function handleAdError() {
			const container = document.getElementById('tads-container-308');
			if (container) {
				container.classList.add('error');
				container.classList.remove('loading', 'ready');
			}
		}

		function initializeAd() {
			try {
				adController = window.tads.init({
					widgetId: 308,
					debug: false,
					onShowReward: (adId) => {
						console.log('Show ad:', adId);
						isAdFullyLoaded = true;
						checkAndShowAd();
					},
					onClickReward: (adId) => {
						console.log('Click on ad:', adId);
					},
					onAdsNotFound: adsNotFoundCallback
				});
				return true;
			} catch (error) {
				console.error('Error initializing Tads.me:', error);
				return false;
			}
		}

		function checkAdContent() {
			const container = document.getElementById('tads-container-308');
			if (!container) return false;

			// Проверяем наличие контента рекламы
			const hasContent = container.children.length > 0 && 
				container.querySelector('a') !== null && 
				container.querySelector('img') !== null;

			if (!hasContent) {
				console.log('Ad content not fully loaded yet');
				return false;
			}

			// Проверяем, что все изображения загружены
			const images = container.querySelectorAll('img');
			const imagesLoaded = Array.from(images).every(img => img.complete && img.naturalHeight !== 0);

			if (!imagesLoaded) {
				console.log('Images not fully loaded yet');
				return false;
			}

			return true;
		}

		function loadAd() {
			if (!adController) {
				if (!initializeAd()) {
					return;
				}
			}

			const container = document.getElementById('tads-container-308');
			if (container) {
				container.classList.remove('error');
				container.classList.add('loading');
			}

			// Очищаем предыдущий таймаут
			if (loadTimeoutId) {
				clearTimeout(loadTimeoutId);
			}

			adController.loadAd()
				.then(() => {
					console.log('Ad loaded successfully');
					adController.showAd();
					checkContainerReady();
				})
				.catch((err) => {
					console.log('Error loading ad:', err);
					adsNotFoundCallback();
				});

			// Устанавливаем новый таймаут
			loadTimeoutId = setTimeout(() => {
				console.log('Ad load timeout reached');
				handleAdError();
				adsNotFoundCallback();
			}, LOAD_TIMEOUT);
		}

		// Function to check if ad is ready to be shown
		function checkAndShowAd() {
			if (isAdFullyLoaded && isAdContainerReady) {
				const container = document.getElementById('tads-container-308');
				if (container) {
					// Проверяем полную загрузку контента
					if (!checkAdContent()) {
						console.log('Waiting for ad content to fully load...');
						setTimeout(checkAndShowAd, 500);
						return;
					}

					container.classList.remove('loading');
					container.style.display = 'block';
					
					// Увеличиваем задержку перед показом
					setTimeout(() => {
						container.classList.add('ready');
					}, 500);
				}
			}
		}

		// Function to check if container is ready
		function checkContainerReady() {
			const container = document.getElementById('tads-container-308');
			if (container) {
				isAdContainerReady = true;
				checkAndShowAd();
			}
		}

		// Start loading ad when page is ready
		window.addEventListener('load', () => {
			checkContainerReady();
			loadAd();
		});

		// Fallback initialization
		if (document.readyState === 'complete') {
			loadAd();
		}
	</script>
</body> 
</html>